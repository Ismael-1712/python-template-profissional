#!/bin/bash
# =============================================================================
# Git Pre-Push Hook: Mutation Testing Alert + Dependency Integrity
# =============================================================================

# Cores para alerta visual
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

# Detecta Python
HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${HOOK_DIR}/../.." && pwd)"

if [ -f "${PROJECT_ROOT}/.venv/bin/python" ]; then
    PYTHON="${PROJECT_ROOT}/.venv/bin/python"
elif command -v python3.10 &> /dev/null; then
    PYTHON="python3.10"
elif command -v python3 &> /dev/null; then
    PYTHON="python3"
else
    PYTHON="python"
fi

# =============================================================================
# FASE 1: ValidaÃ§Ã£o de Integridade CriptogrÃ¡fica (v2.2 Protocol)
# =============================================================================
echo -e "${BLUE}ğŸ›¡ï¸  GuardiÃ£o de DependÃªncias v2.2 - ValidaÃ§Ã£o PrÃ©-Push${NC}"
echo "=================================================="

cd "${PROJECT_ROOT}"

if ${PYTHON} scripts/ci/verify_deps.py --validate-seal 2>/dev/null; then
    echo -e "${GREEN}âœ… Selo de integridade VÃLIDO${NC}"
else
    EXIT_CODE=$?
    if [ ${EXIT_CODE} -eq 2 ]; then
        echo ""
        echo -e "${RED}ğŸš« PRE-PUSH BLOQUEADO: Falha na validaÃ§Ã£o de integridade${NC}"
        echo ""
        echo -e "${YELLOW}ğŸ’Š AUTOCURA RECOMENDADA:${NC}"
        echo "   1. Execute: make deps-fix"
        echo "   2. Commit: git add requirements/dev.txt"
        echo "   3. Commit: git commit --amend --no-edit"
        echo "   4. Retry:  git push"
        echo ""
        exit 1
    fi
    # Se exit code nÃ£o Ã© 2, apenas aviso (selo pode nÃ£o existir ainda)
    echo -e "${YELLOW}âš ï¸  Aviso: ValidaÃ§Ã£o de selo nÃ£o disponÃ­vel (possÃ­vel primeiro push)${NC}"
fi

echo ""

# =============================================================================
# FASE 2: Alerta de Mutation Testing (Original)
# =============================================================================
CORE_PATTERN="scripts/core/"
CHANGED_FILES=$(git diff --name-only HEAD origin/main 2>/dev/null)

if echo "$CHANGED_FILES" | grep -q "$CORE_PATTERN"; then
    echo -e "\n${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘ ğŸš¨  ALERTA SRE: AlteraÃ§Ã£o em LÃ³gica de NegÃ³cio (Core)   â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

    echo -e "${YELLOW}Arquivos sensÃ­veis modificados:${NC}"
    FILES_AFFECTED=$(echo "$CHANGED_FILES" | grep "$CORE_PATTERN")
    echo "$FILES_AFFECTED" | head -n 3
    [ $(echo "$FILES_AFFECTED" | wc -l) -gt 3 ] && echo "... e outros."

    FIRST_FILE=$(echo "$FILES_AFFECTED" | head -n 1)

    echo -e "\n${CYAN}ğŸ’¡ RecomendaÃ§Ã£o de Qualidade:${NC}"
    echo -e "Antes de considerar esta tarefa pronta, execute:"
    echo -e "\n    ${RED}mutmut run --paths-to-mutate $FIRST_FILE --simple-output --runner \"python -m pytest -n 10 -x\"${NC}\n"

    echo -e "${YELLOW}âš ï¸  O Push prosseguirÃ¡ em 3 segundos...${NC}"
    sleep 3
fi

exit 0
