# ======================================================================
# COPIER TEMPLATE CONFIGURATION
# ======================================================================
# Professional Python Template with Smart Update Support
# Preserves user customizations during template updates via toml-fusion
#
# Documentation: https://copier.readthedocs.io/
# ======================================================================

# Minimum Copier version required
_min_copier_version: "9.0.0"

# Template metadata
_templates_suffix: .jinja

# ======================================================================
# SEÃ‡ÃƒO 1: METADADOS DO PROJETO
# ======================================================================
project_name:
  type: str
  help: "Nome legÃ­vel do projeto (ex: 'Meu Projeto IncrÃ­vel')"
  default: "My Awesome Project"

project_slug:
  type: str
  help: "Slug do projeto para pacote Python (snake_case)"
  default: "{{ project_name | lower | replace(' ', '_') | replace('-', '_') }}"
  validator: "^[a-z][a-z0-9_]*$"

project_description:
  type: str
  help: "Breve descriÃ§Ã£o do projeto (mÃ¡x 200 caracteres)"
  default: "A professional Python project built with CORTEX architecture"
  validator: "^.{10,200}$"

# ======================================================================
# SEÃ‡ÃƒO 2: AUTORIA E REPOSITÃ“RIO
# ======================================================================
author_name:
  type: str
  help: "Nome completo do autor ou organizaÃ§Ã£o"
  default: "Your Name"

author_email:
  type: str
  help: "Email de contato do autor"
  default: "your-email@example.com"
  validator: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"

github_username:
  type: str
  help: "Seu username do GitHub (para construir repository_url)"
  default: "yourusername"
  validator: "^[a-zA-Z0-9]([a-zA-Z0-9-]{0,37}[a-zA-Z0-9])?$"

repository_url:
  type: str
  help: "URL completa do repositÃ³rio GitHub"
  default: "https://github.com/{{ github_username }}/{{ project_slug | replace('_', '-') }}"
  validator: "^https://github\\.com/.+/.+$"

# ======================================================================
# SEÃ‡ÃƒO 3: CONFIGURAÃ‡ÃƒO TÃ‰CNICA
# ======================================================================
python_version:
  type: str
  help: "VersÃ£o mÃ­nima do Python (formato: '3.10', '3.11', etc.)"
  default: "3.10"
  choices:
    - "3.10"
    - "3.11"
    - "3.12"
    - "3.13"

initial_version:
  type: str
  help: "VersÃ£o inicial do projeto (SemVer: X.Y.Z)"
  default: "0.1.0"
  validator: "^\\d+\\.\\d+\\.\\d+$"

# ======================================================================
# SEÃ‡ÃƒO 4: FEATURES OPCIONAIS
# ======================================================================
enable_docker:
  type: bool
  help: "Incluir Dockerfile e docker-compose.yml?"
  default: true

enable_mkdocs:
  type: bool
  help: "Incluir documentaÃ§Ã£o MkDocs Material?"
  default: true

enable_cortex_neural:
  type: bool
  help: "Incluir CORTEX Neural (Vector Search com ChromaDB)?"
  default: false

default_reviewers:
  type: str
  help: "GitHub handles para CODEOWNERS (separados por vÃ­rgula, ex: '@team1,@user2') - deixe vazio para nÃ£o configurar"
  default: ""

# ======================================================================
# SEÃ‡ÃƒO 5: VARIÃVEIS AUTOMÃTICAS (OCULTAS)
# ======================================================================
copyright_year:
  type: str
  help: "Ano do copyright (calculado automaticamente)"
  default: "{% now 'utc', '%Y' %}"
  when: false  # Ocultar da UI

copyright_holder:
  type: str
  help: "Titular do copyright (default: author_name)"
  default: "{{ author_name }}"
  when: false

project_cli_name:
  type: str
  help: "Nome do comando CLI (kebab-case)"
  default: "{{ project_slug | replace('_', '-') }}"
  when: false

python_target_version:
  type: str
  help: "Python version para Ruff e Mypy (formato: py310)"
  default: "py{{ python_version | replace('.', '') }}"
  when: false

# ======================================================================
# ARQUIVOS E PASTAS A EXCLUIR
# ======================================================================
_exclude:
  # ConfiguraÃ§Ãµes do usuÃ¡rio (nunca sobrescrever)
  - .env
  - .env.*
  - "!.env.example"

  # Contexto dinÃ¢mico gerado (runtime)
  - .cortex/
  - audit_report_*.json
  - sync_report_*.json
  - audit_dashboard.html
  - audit_metrics.json

  # Build artifacts e cache
  - .venv/
  - __pycache__/
  - "*.egg-info/"
  - build/
  - dist/
  - "*.pyc"

  # ConfiguraÃ§Ãµes do Copier (gerenciadas automaticamente)
  - .copier-answers.yml

  # Git (Ã³bvio, mas por seguranÃ§a)
  - .git/

  # Logs e cache de ferramentas
  - "*.log"
  - .ruff_cache/
  - .mypy_cache/
  - .pytest_cache/
  - .tox/

  # Arquivos temporÃ¡rios e backups
  - "*.bak"
  - "*.bak.*"
  - "*.backup"
  - README.md.backup
  - project_structure.txt

  # RelatÃ³rios histÃ³ricos (nÃ£o devem ser sobrescritos)
  - docs/reports/**
  - SPRINT4_MYPY_SUMARIO.txt

# ======================================================================
# ARQUIVOS QUE NÃƒO DEVEM SER SOBRESCRITOS SE JÃ EXISTIREM
# ======================================================================
_skip_if_exists:
  # DocumentaÃ§Ã£o customizada pelo usuÃ¡rio
  - docs/guides/**
  - docs/knowledge/**

  # Scripts customizados
  - scripts/cli/custom_*.py

  # Testes customizados
  - tests/custom_*.py

  # GitHub workflows customizados
  - .github/workflows/custom_*.yml

# ======================================================================
# TAREFAS PÃ“S-GERAÃ‡ÃƒO/ATUALIZAÃ‡ÃƒO
# ======================================================================
_tasks:
  # Task 1: Executar toml-fusion em updates para preservar customizaÃ§Ãµes
  - task: |
      {% if _copier_conf.is_update %}
      echo "ğŸ”„ Executando Smart Update via toml-fusion..."
      if command -v toml-fusion &> /dev/null; then
        toml-fusion {{ _copier_conf.src_path }}/pyproject.toml.jinja pyproject.toml --strategy=smart || echo "âš ï¸  Aviso: toml-fusion falhou. Revise manualmente."
      else
        echo "âš ï¸  toml-fusion nÃ£o encontrado. Instale dependÃªncias: pip install -e ."
      fi
      {% else %}
      echo "âœ… Primeira geraÃ§Ã£o - toml-fusion nÃ£o necessÃ¡rio"
      {% endif %}
    when: "{{ _copier_conf.is_update or false }}"

  # Task 2: Instalar dependÃªncias de desenvolvimento (opcional)
  - task: |
      {% if not _copier_conf.is_update %}
      echo ""
      echo "ğŸ“¦ PrÃ³ximos passos:"
      echo "  1. cd {{ _copier_conf.dst_path | basename }}"
      echo "  2. make setup          # Criar venv e instalar deps"
      echo "  3. make doctor         # Validar ambiente"
      echo "  4. git init && git add . && git commit -m 'Initial commit from CORTEX template'"
      echo ""
      {% endif %}
    when: "{{ not _copier_conf.is_update }}"

# ======================================================================
# MENSAGENS DE AJUDA
# ======================================================================
_message_before_copy: |
  ğŸ§  CORTEX â€” Professional Python Template
  ========================================

  VocÃª estÃ¡ prestes a criar um projeto Python com:
  - âœ… Type Safety (mypy strict)
  - âœ… Code Quality (ruff, pytest)
  - âœ… Documentation as Code (CORTEX)
  - âœ… SRE Automation (dev-doctor, git-sync)
  - âœ… Smart Update (preserva suas customizaÃ§Ãµes)

  Responda as perguntas abaixo:

_message_after_copy: |
  ğŸ‰ Projeto criado com sucesso!

  ğŸ“ Estrutura gerada em: {{ _copier_conf.dst_path }}

  ğŸš€ PrÃ³ximos comandos:
    cd {{ _copier_conf.dst_path | basename }}
    make setup      # Configura ambiente virtual
    make doctor     # Valida instalaÃ§Ã£o
    make test       # Executa testes

  ğŸ“š DocumentaÃ§Ã£o completa:
    make help       # Lista todos os comandos
    cat README.md   # Leia a arquitetura CORTEX

  ğŸ”„ Para atualizar o template no futuro:
    copier update

  Bom trabalho! ğŸ§ 

_message_before_update: |
  ğŸ”„ Atualizando template CORTEX...

  âš ï¸  IMPORTANTE:
  - Suas configuraÃ§Ãµes em pyproject.toml serÃ£o preservadas via toml-fusion
  - Arquivos em .env, .cortex/, docs/knowledge/ NÃƒO serÃ£o sobrescritos
  - Um backup serÃ¡ criado antes de qualquer mudanÃ§a

  Pronto para continuar?

_message_after_update: |
  âœ… Template atualizado com sucesso!

  ğŸ” Revise as mudanÃ§as:
    git diff pyproject.toml  # Verificar merge do TOML
    git status               # Ver todos os arquivos modificados

  ğŸ§ª Valide a atualizaÃ§Ã£o:
    make validate            # Lint + Type Check + Tests
    make doctor              # DiagnÃ³stico completo

  ğŸ“ Se algo deu errado:
    git checkout pyproject.toml.bak.*  # Restaurar backup
    git reset --hard HEAD              # Reverter tudo

  Smart Update concluÃ­do! ğŸš€
