# .pre-commit-config.yaml
# Define os "porteiros" que rodam antes de cada commit

repos:
  # 1. Ganchos Padr√£o (Verifica arquivos que n√£o s√£o Python)
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      - id: check-added-large-files # Impede commit de arquivos > 5MB
      - id: check-toml              # Valida pyproject.toml
      - id: check-yaml              # Valida .yml
        args: [--unsafe]            # Permite tags customizadas do MkDocs (CR√çTICO)
      - id: end-of-file-fixer       # Garante uma linha em branco no final
      - id: trailing-whitespace     # Remove espa√ßos em branco

  # 2. Ruff (O Linter e Formatador)
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.6  # ‚ö†Ô∏è MANTER SINCRONIZADO COM requirements/dev.txt
    hooks:
      - id: ruff-format # Roda o formatador (substituto do Black)
      - id: ruff        # Roda o linter (substituto do Flake8)

  # 3. Mypy (Type Checking)
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.19.0  # ‚ö†Ô∏è MANTER SINCRONIZADO COM requirements/dev.txt
    hooks:
      - id: mypy
        args: [--config-file=pyproject.toml, --python-version=3.10]
        additional_dependencies:
          - types-PyYAML==6.0.12.20250915
          - types-requests==2.32.4.20250913
          - pydantic>=2.0
          - pydantic-settings>=2.0
        pass_filenames: true
        types: [python]
        exclude: ^scripts/audit_dashboard\.py

  # 4. Nosso Auditor Customizado (O "Sistema de Auditoria")
  - repo: local
    hooks:
      - id: code-audit-security
        name: "Auditoria de Seguran√ßa Customizada (Delta)"
        entry: env PRE_COMMIT=1 python3 scripts/cli/audit.py --config scripts/audit_config.yaml --fail-on HIGH --quiet
        language: system
        pass_filenames: true
        types: [python]

      - id: cortex-audit
        name: "CORTEX - Auditoria de Documenta√ß√£o"
        entry: env PRE_COMMIT=1 python3 -m scripts.core.cortex.project_orchestrator audit docs/ --fail-on-error
        language: system
        pass_filenames: false
        types_or: [markdown, python]
        files: \.(md|py)$
        exclude: \.(j2|jinja|jinja2)$

      - id: cortex-guardian
        name: "CORTEX Guardian - Bloqueia Shadow Configuration"
        entry: python3 -m scripts.core.cortex.project_orchestrator guardian check . --fail-on-error
        language: system
        pass_filenames: false
        types: [python]

      - id: auto-doc-gen
        name: "Auto-Generate CLI Docs"
        entry: env PRE_COMMIT=1 python3 scripts/core/doc_gen.py
        language: system
        pass_filenames: false
        files: ^(scripts/cli/|scripts/core/).*\.py$
        types: [python]

      - id: cortex-neural-sync
        name: "CORTEX Neural Auto-Sync"
        entry: python -m scripts.core.cortex.project_orchestrator neural index
        language: system
        types: [markdown]
        pass_filenames: false
        description: "Automatically updates the vector store when documentation changes."

      - id: tdd-guardian
        name: "TDD Guardian - Requer testes para c√≥digo novo (src/)"
        entry: python3 scripts/hooks/tdd_guardian.py --dirs src
        language: system
        pass_filenames: true
        types: [python]
        files: ^src/
        description: "Garante que novos arquivos em src/ tenham testes correspondentes em tests/ (MODO STRICT)"

      - id: tdd-guardian-scripts
        name: "TDD Guardian - Monitora scripts/ (WARN-ONLY)"
        entry: python3 scripts/hooks/tdd_guardian.py --dirs scripts --warn-only
        language: system
        pass_filenames: true
        types: [python]
        files: ^scripts/
        description: "Monitora scripts/ e avisa sobre testes faltantes (n√£o bloqueia commits)"

      - id: lockfile-sync-guard
        name: "üîí Lockfile Sync Guard - Bloqueia commits com requirements dessincronizados"
        entry: python scripts/ci/verify_deps.py
        language: system
        pass_filenames: false
        files: ^requirements/.*\.(in|txt)$
        description: "Garante que requirements.txt est√° sincronizado com .in antes de commits (AUTOIMUNIDADE)"

      - id: pip-audit-sca
        name: "üõ°Ô∏è SCA - Detecta CVEs em Depend√™ncias (pip-audit)"
        entry: python -m pip_audit . --desc
        language: system
        pass_filenames: false
        files: ^requirements/.*\.(in|txt)$
        description: "Bloqueia commits com vulnerabilidades n√£o ignoradas (l√™ exce√ß√µes de pyproject.toml)"

  - repo: local
    hooks:
      - id: governance-policy-strict
        name: CORTEX - Governan√ßa Estrita (Pytest)
        entry: python -m pytest tests/test_governance_policies.py
        language: system
        files: ^docs/.*\.md$
        pass_filenames: false
        always_run: true
