# ======================================================================
# ðŸ” AUDITORIA AGENDADA DE DEPENDÃŠNCIAS
# ======================================================================
# Este workflow executa auditoria automatizada de dependÃªncias de forma
# periÃ³dica para detectar violaÃ§Ãµes arquiteturais antes que se tornem
# problemas crÃ­ticos.
#
# ESTRATÃ‰GIA:
# - ExecuÃ§Ã£o: Toda segunda-feira Ã s 09:00 UTC
# - Objetivo: Detectar dependÃªncias cÃ­clicas e violaÃ§Ãµes de hierarquia
# - NotificaÃ§Ã£o: Cria issue automÃ¡tica em caso de falhas
#
# AUTOR: DevOps Engineering Team
# VERSÃƒO: 1.0.0
# ======================================================================

name: "ðŸ” Auditoria Agendada de DependÃªncias"

on:
  # ExecuÃ§Ã£o agendada: Toda segunda-feira Ã s 09:00 UTC
  schedule:
    - cron: '0 9 * * 1'

  # Permite execuÃ§Ã£o manual para testes
  workflow_dispatch:

permissions:
  contents: read
  issues: write  # Para criar issues em caso de problemas

jobs:
  # --------------------------------------------------------------------
  # JOB: AUDITORIA DE DEPENDÃŠNCIAS
  # --------------------------------------------------------------------
  audit-dependencies:
    name: "ðŸ›¡ï¸ Verificar SaÃºde Arquitetural"
    runs-on: ubuntu-latest

    steps:
      # --- 1. CHECKOUT ---
      - name: "Checkout do RepositÃ³rio"
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # --- 2. CONFIGURAR PYTHON ---
      - name: "Configurar Python 3.11"
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.11"
          cache: "pip"

      # --- 3. INSTALAR DEPENDÃŠNCIAS ---
      - name: "Instalar DependÃªncias do Projeto"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/dev.txt

      # --- 4. EXECUTAR AUDITORIA ---
      - name: "ðŸ” Executar Auditoria de DependÃªncias"
        id: audit
        run: |
          echo "::group::Auditoria de DependÃªncias"
          python scripts/audit_dependencies.py --json > audit_result.json
          echo "::endgroup::"

          # Verificar se hÃ¡ violaÃ§Ãµes
          if python scripts/audit_dependencies.py --ci; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      # --- 5. UPLOAD DE ARTEFATOS ---
      - name: "ðŸ“¦ Upload Resultado da Auditoria"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-report-${{ github.run_number }}
          path: audit_result.json
          retention-days: 30

      # --- 6. CRIAR ISSUE EM CASO DE FALHA ---
      - name: "ðŸš¨ Criar Issue de ViolaÃ§Ã£o Detectada"
        if: steps.audit.outputs.status == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const auditData = JSON.parse(fs.readFileSync('audit_result.json', 'utf8'));

            const violationCount = auditData.violations.length;
            const timestamp = auditData.timestamp;

            const issueBody = `## ðŸš¨ ViolaÃ§Ãµes Arquiteturais Detectadas

            **Data da Auditoria:** ${timestamp}
            **Total de ViolaÃ§Ãµes:** ${violationCount}

            ### Detalhes

            \`\`\`json
            ${JSON.stringify(auditData, null, 2)}
            \`\`\`

            ### AÃ§Ã£o Requerida

            Por favor, revise as violaÃ§Ãµes acima e tome as medidas corretivas:
            1. Corrija as dependÃªncias cÃ­clicas identificadas
            2. Reverta violaÃ§Ãµes de hierarquia de camadas
            3. Execute \`python scripts/audit_dependencies.py\` localmente para validar

            ---
            _Este issue foi criado automaticamente pelo workflow de auditoria agendada._
            _Workflow Run: [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})_
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Auditoria: ${violationCount} ViolaÃ§Ã£o(Ãµes) Arquitetural(is) Detectada(s)`,
              body: issueBody,
              labels: ['audit', 'dependencies', 'tech-debt', 'automated']
            });

      # --- 7. NOTIFICAR SUCESSO ---
      - name: "âœ… Auditoria ConcluÃ­da com Sucesso"
        if: steps.audit.outputs.status == 'success'
        run: |
          echo "âœ… Nenhuma violaÃ§Ã£o arquitetural detectada!"
          echo "ðŸ“Š RelatÃ³rio completo disponÃ­vel nos artefatos."
