# ======================================================================
# ðŸ§Ÿ MUTATION TESTING AUDIT - SCHEDULED NIGHTLY
# ======================================================================
# Este workflow executa testes de mutaÃ§Ã£o de forma agendada para auditar
# a qualidade da suÃ­te de testes sem impactar o fluxo de desenvolvimento.
#
# ESTRATÃ‰GIA:
# - ExecuÃ§Ã£o: Diariamente Ã s 03:00 AM BRT (06:00 UTC)
# - Objetivo: Validar eficÃ¡cia dos testes contra mutaÃ§Ãµes de cÃ³digo
# - Foco: scripts/core (nÃºcleo do projeto)
# - Limite: 6h (timeout do GitHub Actions)
#
# MUTAÃ‡ÃƒO:
# - Ferramenta: mutmut
# - Output: RelatÃ³rio HTML com anÃ¡lise detalhada
# - Artefato: DisponÃ­vel para download por 30 dias
#
# NOTA TÃ‰CNICA: HorÃ¡rio de BrasÃ­lia (BRT) Ã© UTC-3
# - 03:00 BRT = 06:00 UTC
#
# AUTOR: DevOps Engineering Team
# VERSÃƒO: 1.0.0
# ======================================================================

name: "ðŸ§Ÿ Mutation Testing Audit"

on:
  # ExecuÃ§Ã£o agendada: Diariamente Ã s 03:00 AM BRT (06:00 UTC)
  schedule:
    - cron: '0 6 * * *'

  # Permite execuÃ§Ã£o manual para testes e debugging
  workflow_dispatch:

permissions:
  contents: read

# Timeout global para evitar custos excessivos
# Mutation testing pode ser lento, mas limitamos a 6h
env:
  MUTATION_TIMEOUT: 21600  # 6 horas em segundos

jobs:
  # --------------------------------------------------------------------
  # JOB: MUTATION ANALYSIS
  # --------------------------------------------------------------------
  mutation-analysis:
    name: "ðŸ§¬ Mutation Analysis (Core)"
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 horas

    env:
      CI: true
      PYTHONUNBUFFERED: 1

    steps:
      # --- 1. CHECKOUT ---
      - name: "ðŸ“¥ Checkout do RepositÃ³rio"
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0  # HistÃ³ria completa para anÃ¡lise

      # --- 2. CONFIGURAR PYTHON ---
      - name: "ðŸ Configurar Python 3.12"
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"
          cache: "pip"

      # --- 3. INSTALAR DEPENDÃŠNCIAS ---
      - name: "ðŸ“¦ Instalar DependÃªncias do Projeto"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/dev.txt

      # --- 4. EXECUTAR MUTATION TESTING ---
      - name: "ðŸ§Ÿ Executar Mutation Testing (Core)"
        id: mutation
        run: |
          echo "::group::Mutation Testing - Core"
          echo "ðŸŽ¯ Foco: scripts/core/"
          echo "â±ï¸  Timeout: 6 horas"
          echo ""

          # Executar mutmut focado no core (CI mode - sem interatividade)
          python -m mutmut run \
            --paths-to-mutate scripts/core \
            --no-progress \
            --CI || echo "status=partial" >> $GITHUB_OUTPUT

          echo "::endgroup::"

          # Capturar estatÃ­sticas
          echo "::group::Mutation Statistics"
          python -m mutmut results
          echo "::endgroup::"
        continue-on-error: true

      # --- 5. GERAR RELATÃ“RIO HTML ---
      - name: "ðŸ“Š Gerar RelatÃ³rio HTML"
        if: always()
        run: |
          echo "::group::Generating HTML Report"
          python -m mutmut html
          echo "::endgroup::"

          # Adicionar timestamp ao relatÃ³rio
          echo "Generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > html/timestamp.txt
          echo "Commit: ${GITHUB_SHA}" >> html/timestamp.txt

      # --- 6. UPLOAD DE ARTEFATOS ---
      - name: "ðŸ“¦ Upload RelatÃ³rio de MutaÃ§Ã£o"
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: mutation-report-${{ github.run_number }}
          path: html/
          retention-days: 30
          if-no-files-found: warn

      # --- 7. SUMÃRIO DO WORKFLOW ---
      - name: "ðŸ“‹ SumÃ¡rio da ExecuÃ§Ã£o"
        if: always()
        run: |
          echo "## ðŸ§Ÿ Mutation Testing Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“… Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¯ Target: \`scripts/core/\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ Commit: \`${GITHUB_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Results:**" >> $GITHUB_STEP_SUMMARY

          if [ -f .mutmut-cache ]; then
            python -m mutmut results >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No mutation cache found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ Download the HTML report from workflow artifacts." >> $GITHUB_STEP_SUMMARY
