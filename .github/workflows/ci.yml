# ======================================================================
# üöÄ PISTOL√ÉO DE QUALIDADE - PYTHON (v6.0 - Topology Optimized)
# ======================================================================
# Este workflow √© o "Porteiro de CI" para o python-template-profissional.
#
# ARQUITETURA OTIMIZADA (N√≠vel 3 - Waterfall Fix):
# - Cache agressivo multin√≠vel (pip, venv, mypy, pytest) por vers√£o Python
# - Jobs DESACOPLADOS: cada vers√£o Python roda independentemente
# - Elimina√ß√£o do Waterfall Bottleneck (setup n√£o bloqueia todos os testes)
# - Jobs paralelos otimizados:
#   * Quality (lint/security): Python 3.12 apenas
#   * Tests: 3 jobs independentes (3.10, 3.11, 3.12)
# - Pytest-xdist para paralelismo de testes
#
# META DE PERFORMANCE: < 5 minutos (antes: 13min)
# OTIMIZA√á√ïES: Topologia pipeline + cache L2 (pytest)
# ======================================================================

name: "üöÄ CI: Teste, Lint e Qualidade"

on:
  push:
    branches: [main, api, cli]
  pull_request:
    branches: [main, api, cli]
  workflow_dispatch:

permissions:
  contents: read

# Cancela workflows antigos da mesma branch para economizar tempo
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ====================================================================
  # JOB 1: QUALITY CHECKS (Python 3.12 com setup inline)
  # ====================================================================
  # Lint, format check, type checking e security audit.
  # Setup inline para eliminar depend√™ncia de job separado.
  # ====================================================================
  quality:
    name: "üîç Quality & Security"
    runs-on: ubuntu-latest

    env:
      CI: true

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Configurar Python 3.10 (baseline)"
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.10"
          cache: 'pip'
          cache-dependency-path: 'requirements/dev.txt'

      # Cache compartilhado de pip (wheels baixados)
      - name: "Cache pip downloads"
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements/dev.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      # Cache do venv espec√≠fico Python 3.10 (baseline)
      - name: "Cache virtual environment"
        id: cache-venv
        uses: actions/cache@v5
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.10-${{ hashFiles('requirements/dev.txt') }}
          restore-keys: |
            venv-${{ runner.os }}-py3.10-

      # Verificar consist√™ncia do lockfile (Python 3.10 baseline)
      - name: "Check Lockfile Consistency"
        run: |
          python -m pip install pip-tools
          pip-compile requirements/dev.in
          if ! git diff --exit-code requirements/dev.txt; then
            echo "‚ùå ERROR: requirements/dev.txt is out of sync with dev.in"
            echo "Run 'make install-dev' locally and commit the updated dev.txt"
            exit 1
          fi
          echo "‚úÖ Lockfile is consistent"

      # S√≥ instala se o cache falhou
      - name: "Instalar Depend√™ncias"
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: make install-dev

      # Cache do mypy (type checking incremental)
      - name: "Restaurar cache do mypy"
        uses: actions/cache@v5
        with:
          path: .mypy_cache
          key: mypy-${{ runner.os }}-${{ hashFiles('scripts/**/*.py', 'src/**/*.py', 'tests/**/*.py') }}
          restore-keys: |
            mypy-${{ runner.os }}-

      # Verifica√ß√£o de formata√ß√£o (ruff format --check)
      - name: "Verificar Formata√ß√£o"
        run: |
          make format
          git diff --exit-code -- . ':(exclude)requirements/dev.txt' ':(exclude)audit_metrics.json'

      # Linting (ruff check)
      - name: "Executar Linting"
        run: make lint

      # Type checking (mypy)
      - name: "Executar Type Checking"
        run: make type-check

      # Security audit (depend√™ncias + an√°lise est√°tica)
      - name: "Audit Dependencies"
        run: .venv/bin/python scripts/audit_dependencies.py --ci

      - name: "Security Audit (Static Analysis)"
        run: make audit

      # CORTEX Guardian (configura√ß√µes n√£o documentadas)
      - name: "Check Undocumented Configuration"
        run: .venv/bin/python -m scripts.cortex guardian check . --fail-on-error

  # ====================================================================
  # JOB 2: TESTS Python 3.10 (INDEPENDENTE)
  # ====================================================================
  # Setup inline + testes. N√£o aguarda outros jobs.
  # ====================================================================
  tests-py310:
    name: "üß™ Tests Python 3.10"
    runs-on: ubuntu-latest

    env:
      CI: true

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Configurar Python 3.10"
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.10"
          cache: 'pip'
          cache-dependency-path: 'requirements/dev.txt'

      # Cache compartilhado de pip
      - name: "Cache pip downloads"
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements/dev.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      # Cache do venv Python 3.10
      - name: "Cache virtual environment"
        id: cache-venv
        uses: actions/cache@v5
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.10-${{ hashFiles('requirements/dev.txt') }}
          restore-keys: |
            venv-${{ runner.os }}-py3.10-

      # Cache do pytest (L2)
      - name: "Cache pytest"
        uses: actions/cache@v5
        with:
          path: .pytest_cache
          key: pytest-${{ runner.os }}-py3.10-${{ hashFiles('tests/**/*.py') }}
          restore-keys: |
            pytest-${{ runner.os }}-py3.10-

      # S√≥ instala se o cache falhou
      - name: "Instalar Depend√™ncias"
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: make install-dev

      # Garantir pytest mesmo com cache sujo
      - name: "Verificar disponibilidade do pytest"
        run: .venv/bin/python -m pip install pytest pytest-xdist types-requests typer

      # Executa testes com pytest-xdist (-n auto)
      - name: "Executar Testes (Paralelo)"
        run: make test-ci

  # ====================================================================
  # JOB 3: TESTS Python 3.11 (INDEPENDENTE)
  # ====================================================================
  tests-py311:
    name: "üß™ Tests Python 3.11"
    runs-on: ubuntu-latest

    env:
      CI: true

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Configurar Python 3.11"
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: 'requirements/dev.txt'

      # Cache compartilhado de pip
      - name: "Cache pip downloads"
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements/dev.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      # Cache do venv Python 3.11
      - name: "Cache virtual environment"
        id: cache-venv
        uses: actions/cache@v5
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.11-${{ hashFiles('requirements/dev.txt') }}
          restore-keys: |
            venv-${{ runner.os }}-py3.11-

      # Cache do pytest (L2)
      - name: "Cache pytest"
        uses: actions/cache@v5
        with:
          path: .pytest_cache
          key: pytest-${{ runner.os }}-py3.11-${{ hashFiles('tests/**/*.py') }}
          restore-keys: |
            pytest-${{ runner.os }}-py3.11-

      # S√≥ instala se o cache falhou
      - name: "Instalar Depend√™ncias"
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: make install-dev

      # Garantir pytest mesmo com cache sujo
      - name: "Verificar disponibilidade do pytest"
        run: .venv/bin/python -m pip install pytest pytest-xdist types-requests typer

      # Executa testes com pytest-xdist (-n auto)
      - name: "Executar Testes (Paralelo)"
        run: make test-ci

  # ====================================================================
  # JOB 4: TESTS Python 3.12 (INDEPENDENTE)
  # ====================================================================
  tests-py312:
    name: "üß™ Tests Python 3.12"
    runs-on: ubuntu-latest

    env:
      CI: true

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Configurar Python 3.12"
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"
          cache: 'pip'
          cache-dependency-path: 'requirements/dev.txt'

      # Cache compartilhado de pip
      - name: "Cache pip downloads"
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements/dev.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      # Cache do venv Python 3.12
      - name: "Cache virtual environment"
        id: cache-venv
        uses: actions/cache@v5
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.12-${{ hashFiles('requirements/dev.txt') }}
          restore-keys: |
            venv-${{ runner.os }}-py3.12-

      # Cache do pytest (L2)
      - name: "Cache pytest"
        uses: actions/cache@v5
        with:
          path: .pytest_cache
          key: pytest-${{ runner.os }}-py3.12-${{ hashFiles('tests/**/*.py') }}
          restore-keys: |
            pytest-${{ runner.os }}-py3.12-

      # S√≥ instala se o cache falhou
      - name: "Instalar Depend√™ncias"
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: make install-dev

      # Executa testes com pytest-xdist (-n auto)
      - name: "Executar Testes (Paralelo)"
        run: make test-ci
