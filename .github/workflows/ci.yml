# ======================================================================
# 噫 PISTOLﾃグ DE QUALIDADE - PYTHON (v2.0 - Pﾃｳs-Auditoria)
# ======================================================================
# Este workflow ﾃｩ o "Porteiro de CI" para o python-template-profissional.
#
# ARQUITETURA (Task Runner Pattern):
# Este arquivo Nﾃグ contﾃｩm lﾃｳgica de lint/teste.
# Ele delega TODAS as tarefas ao script centralizado:
#
# ﾂ `scripts/dev_commands.py`
#
# Isso nos dﾃ｡ uma "Fonte ﾃ嗜ica da Verdade" para os comandos.
# ======================================================================

name: "噫 CI: Teste, Lint e Qualidade"

on:
  push:
    branches: [main, api, cli]
  pull_request:
    branches: [main, api, cli]
  # Permite a execuﾃｧﾃ｣o manual
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # --------------------------------------------------------------------
  # JOB 1: VERIFICAﾃﾃグ DE QUALIDADE (LINT, FORMAT, TEST)
  # --------------------------------------------------------------------
  quality-gate:
    name: "ｧｪ Teste e Qualidade"
    runs-on: ubuntu-latest

    # EstratﾃｩgIA de matriz para testar em mﾃｺltiplas versﾃｵes do Python
    # (Definido no Roadmap Mestre, Prioridade 1)
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      # --- 1. CONFIGURAﾃﾃグ (Checkout e Setup) ---
      - name: "Checkout do Repositﾃｳrio"
        uses: actions/checkout@v4

      - name: "Configurar Python ${{ matrix.python-version }}"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          # Ativa o cache de dependﾃｪncias do pip
          cache: "pip"

      # --- 2. INSTALAﾃﾃグ ---
      - name: "Instalar Dependﾃｪncias (via dev_commands)"
        run: |
          # Ativamos o .venv apenas para garantir que o pip instale lﾃ｡
          python3 -m venv .venv
          source .venv/bin/activate
          # Usamos nosso script centralizado para instalar
          python3 scripts/dev_commands.py install-dev

      # --- 3. EXECUﾃﾃグ (Delegaﾃｧﾃ｣o ao Task Runner) ---
      - name: "Executar Verificaﾃｧﾃ｣o de Formataﾃｧﾃ｣o (via dev_commands)"
        run: |
          source .venv/bin/activate
          # Delega ao script. O "--" passa argumentos (como --check)
          python3 scripts/dev_commands.py format -- --check

      - name: "Executar Linting (via dev_commands)"
        run: |
          source .venv/bin/activate
          python3 scripts/dev_commands.py lint

      - name: "Executar Testes (via dev_commands)"
        run: |
          source .venv/bin/activate
          # O script jﾃ｡ estﾃ｡ configurado para `pytest`, incluindo `--cov`
          python3 scripts/dev_commands.py test
