# ======================================================================
# ðŸš€ PISTOLÃƒO DE QUALIDADE - PYTHON (v4.0 - Performance Optimized)
# ======================================================================
# Este workflow Ã© o "Porteiro de CI" para o python-template-profissional.
#
# ARQUITETURA (Task Runner Pattern + Parallel Jobs):
# - Delega TODAS as tarefas ao Makefile padronizado
# - Jobs paralelos para maximizar throughput
# - Cache agressivo de venv, pip e mypy
# - Testes paralelos com pytest-xdist
#
# META DE PERFORMANCE: < 3 minutos (antes: 7-9min)
# ======================================================================

name: "ðŸš€ CI: Teste, Lint e Qualidade"

on:
  push:
    branches: [main, api, cli]
  pull_request:
    branches: [main, api, cli]
  workflow_dispatch:

permissions:
  contents: read

# Cancela workflows antigos da mesma branch para economizar tempo
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # --------------------------------------------------------------------
  # JOB BASE: INSTALA DEPENDÃŠNCIAS (SHARED CACHE)
  # --------------------------------------------------------------------
  setup:
    name: "âš™ï¸ Setup Environment"
    runs-on: ubuntu-latest
    outputs:
      python-version: ${{ steps.setup-python.outputs.python-version }}

    steps:
      - name: "Checkout do RepositÃ³rio"
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Configurar Python 3.12"
        id: setup-python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"

      # Cache do pip (wheels baixados)
      - name: "Cache pip downloads"
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements/dev.in') }}
          restore-keys: |
            pip-${{ runner.os }}-

      # Cache do venv completo (MAIOR GANHO DE PERFORMANCE)
      - name: "Cache virtual environment"
        id: cache-venv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.12-${{ hashFiles('requirements/dev.in') }}
          restore-keys: |
            venv-${{ runner.os }}-py3.12-

      # SÃ³ instala se o cache falhou
      - name: "Instalar DependÃªncias"
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: make install-dev

      # Cache do mypy (cache de type checking)
      - name: "Cache mypy"
        uses: actions/cache@v4
        with:
          path: .mypy_cache
          key: mypy-${{ runner.os }}-${{ hashFiles('scripts/**/*.py', 'src/**/*.py', 'tests/**/*.py') }}
          restore-keys: |
            mypy-${{ runner.os }}-

  # --------------------------------------------------------------------
  # JOB 1: LINT & FORMAT (PARALELO)
  # --------------------------------------------------------------------
  lint:
    name: "ðŸ” Lint & Format"
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Configurar Python"
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"

      # Restaura o venv do cache
      - name: "Restaurar cache do venv"
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.12-${{ hashFiles('requirements/dev.in') }}
          fail-on-cache-miss: true

      - name: "Executar VerificaÃ§Ã£o de FormataÃ§Ã£o"
        run: |
          make format
          git diff --exit-code -- . ':(exclude)requirements/dev.txt' ':(exclude)audit_metrics.json'

      - name: "Executar Linting"
        run: make lint

  # --------------------------------------------------------------------
  # JOB 2: TYPE CHECKING (PARALELO)
  # --------------------------------------------------------------------
  type-check:
    name: "ðŸ”¬ Type Checking"
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Configurar Python"
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"

      - name: "Restaurar cache do venv"
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.12-${{ hashFiles('requirements/dev.in') }}
          fail-on-cache-miss: true

      - name: "Restaurar cache do mypy"
        uses: actions/cache@v4
        with:
          path: .mypy_cache
          key: mypy-${{ runner.os }}-${{ hashFiles('scripts/**/*.py', 'src/**/*.py', 'tests/**/*.py') }}

      - name: "Executar Type Checking"
        run: make type-check

  # --------------------------------------------------------------------
  # JOB 3: SECURITY AUDIT (PARALELO)
  # --------------------------------------------------------------------
  security:
    name: "ðŸ›¡ï¸ Security Audit"
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Configurar Python"
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"

      - name: "Restaurar cache do venv"
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.12-${{ hashFiles('requirements/dev.in') }}
          fail-on-cache-miss: true

      - name: "Audit Dependencies"
        run: .venv/bin/python scripts/audit_dependencies.py --ci

      - name: "Security Audit (Static Analysis)"
        run: make audit

      - name: "Check Undocumented Configuration"
        run: .venv/bin/python -m scripts.cli.cortex guardian check . --fail-on-error

  # --------------------------------------------------------------------
  # JOB 4: TESTS (PARALELO COM PYTEST-XDIST)
  # --------------------------------------------------------------------
  tests:
    name: "ðŸ§ª Tests (Parallel)"
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Configurar Python"
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"

      - name: "Restaurar cache do venv"
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.12-${{ hashFiles('requirements/dev.in') }}
          fail-on-cache-miss: true

      - name: "Executar Testes (Paralelo)"
        run: make test
