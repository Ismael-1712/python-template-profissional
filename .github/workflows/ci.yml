# ======================================================================
# üöÄ PISTOL√ÉO DE QUALIDADE - PYTHON (v6.0 - Topology Optimized)
# ======================================================================
# Este workflow √© o "Porteiro de CI" para o python-template-profissional.
#
# ARQUITETURA OTIMIZADA (N√≠vel 3 - Waterfall Fix):
# - Cache agressivo multin√≠vel (pip, venv, mypy, pytest) por vers√£o Python
# - Jobs DESACOPLADOS: cada vers√£o Python roda independentemente
# - Elimina√ß√£o do Waterfall Bottleneck (setup n√£o bloqueia todos os testes)
# - Jobs paralelos otimizados:
#   * Quality (lint/security): Python 3.12 apenas
#   * Tests: 3 jobs independentes (3.10, 3.11, 3.12)
# - Pytest-xdist para paralelismo de testes
#
# META DE PERFORMANCE: < 5 minutos (antes: 13min)
# OTIMIZA√á√ïES: Topologia pipeline + cache L2 (pytest)
# ======================================================================

name: "üöÄ CI: Teste, Lint e Qualidade"

on:
  push:
    branches: [main, api, cli]
  pull_request:
    branches: [main, api, cli]
  workflow_dispatch:

permissions:
  contents: read

# Cancela workflows antigos da mesma branch para economizar tempo
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ====================================================================
  # JOB 1: QUALITY CHECKS (Python 3.12 com setup inline)
  # ====================================================================
  # Lint, format check, type checking e security audit.
  # Setup inline para eliminar depend√™ncia de job separado.
  # ====================================================================
  quality:
    name: "üîç Quality & Security"
    runs-on: ubuntu-latest

    env:
      CI: true

    steps:
      - uses: actions/checkout@v6

      - name: "Configurar Python 3.10 (baseline)"
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      # Cache compartilhado de pip (wheels baixados)
      - name: "Cache pip downloads"
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements/dev.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      # Cache do venv espec√≠fico Python 3.10 (baseline)
      - name: "Cache virtual environment"
        id: cache-venv
        uses: actions/cache@v5
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.10-${{ hashFiles('requirements/dev.txt') }}
          restore-keys: |
            venv-${{ runner.os }}-py3.10-

      # Verificar consist√™ncia do lockfile (Python 3.10 baseline)
      # FONTE √öNICA DA VERDADE: Deep Consistency Check v2.3 (DRY)
      # HARDENING: Garantir pip-tools dispon√≠vel (n√£o assumir presen√ßa)
      - name: "Install pip-tools for Deep Check"
        run: |
          echo "üîß Ensuring pip-tools is available..."
          pip install pip-tools
          echo "‚úÖ pip-tools installed"

      - name: "Check Lockfile Deep Consistency (v2.3)"
        env:
          PYTHON_BASELINE: "3.10"
        run: |
          echo "üõ°Ô∏è Validando sincroniza√ß√£o de depend√™ncias (Deep Check v2.3)..."
          python -m scripts.core.dependency_guardian validate-deep dev --python-exec python3.10
          echo "‚úÖ Lockfile em paridade total com PyPI (Protocolo v2.3 ativo)"

      # S√≥ instala se o cache falhou
      - name: "Instalar Depend√™ncias"
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: make install-dev

      # Debug: Verificar pacotes instalados (investiga√ß√£o de falha de tipagem)
      - name: "Debug Installed Packages"
        run: |
          .venv/bin/pip list | grep -E "(types-|pydantic)" || true
          .venv/bin/pip show types-PyYAML || echo "‚ùå types-PyYAML NOT FOUND"
          .venv/bin/pip show pydantic-settings || echo "‚ùå pydantic-settings NOT FOUND"
          .venv/bin/pip show types-requests || echo "‚ùå types-requests NOT FOUND"

      # Safety Check: Garantir que type stubs cr√≠ticos estejam instalados
      # (mesmo quando cache venv √© utilizado, pode estar desatualizado)
      - name: "Ensure Type Stubs (Autoimunidade)"
        run: |
          echo "üõ°Ô∏è Verificando stubs cr√≠ticos para MyPy strict mode..."
          MISSING=""
          .venv/bin/pip show types-PyYAML > /dev/null 2>&1 || MISSING="$MISSING types-PyYAML"
          .venv/bin/pip show types-requests > /dev/null 2>&1 || MISSING="$MISSING types-requests"
          .venv/bin/pip show pydantic-settings > /dev/null 2>&1 || MISSING="$MISSING pydantic-settings"

          if [ -n "$MISSING" ]; then
            echo "‚ö†Ô∏è Missing type stubs detected:$MISSING"
            echo "üîß Installing missing packages..."
            .venv/bin/pip install $MISSING
            echo "‚úÖ Type stubs installed successfully"
          else
            echo "‚úÖ All type stubs present (autoimune)"
          fi

      # Cache do mypy (type checking incremental)
      - name: "Restaurar cache do mypy"
        uses: actions/cache@v5
        with:
          path: .mypy_cache
          key: mypy-${{ runner.os }}-${{ hashFiles('scripts/**/*.py', 'src/**/*.py', 'tests/**/*.py') }}
          restore-keys: |
            mypy-${{ runner.os }}-

      # Verifica√ß√£o de formata√ß√£o (ruff format --check)
      - name: "Verificar Formata√ß√£o"
        run: |
          make format
          git diff --exit-code -- . ':(exclude)requirements/dev.txt' ':(exclude)audit_metrics.json'

      # Linting (ruff check)
      - name: "Executar Linting"
        run: make lint

      # Type checking (mypy)
      - name: "Executar Type Checking"
        run: make type-check

      # Security audit (depend√™ncias + an√°lise est√°tica)
      - name: "Audit Dependencies"
        run: .venv/bin/python scripts/audit_dependencies.py --ci

      - name: "Security Audit (Static Analysis)"
        run: make audit

      # Software Composition Analysis (SCA) - CVE Detection
      - name: "üîí Software Composition Analysis (pip-audit)"
        run: |
          echo "üîç Scanning dependencies for known vulnerabilities..."
          .venv/bin/python -m pip_audit . --desc || {
            echo "‚ùå VULNERABILIDADES N√ÉO IGNORADAS DETECTADAS!"
            echo "üíä Adicione exce√ß√µes documentadas em [tool.pip-audit] no pyproject.toml"
            exit 1
          }
          echo "‚úÖ SCA Pass: No non-ignored vulnerabilities detected"

      # CORTEX Guardian (configura√ß√µes n√£o documentadas)
      - name: "Check Undocumented Configuration"
        run: .venv/bin/python -m scripts.cortex guardian-check . --fail-on-error

  # ====================================================================
  # JOB 2: TESTS Python 3.10 (INDEPENDENTE)
  # ====================================================================
  # Setup inline + testes. N√£o aguarda outros jobs.
  # ====================================================================
  tests-py310:
    name: "üß™ Tests Python 3.10"
    runs-on: ubuntu-latest

    env:
      CI: true

    steps:
      - uses: actions/checkout@v6

      - name: "Configurar Python 3.10"
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      # Cache compartilhado de pip
      - name: "Cache pip downloads"
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements/dev.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      # Cache do venv Python 3.10
      - name: "Cache virtual environment"
        id: cache-venv
        uses: actions/cache@v5
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.10-${{ hashFiles('requirements/dev.txt') }}
          restore-keys: |
            venv-${{ runner.os }}-py3.10-

      # Cache do pytest (L2)
      - name: "Cache pytest"
        uses: actions/cache@v5
        with:
          path: .pytest_cache
          key: pytest-${{ runner.os }}-py3.10-${{ hashFiles('tests/**/*.py') }}
          restore-keys: |
            pytest-${{ runner.os }}-py3.10-

      # S√≥ instala se o cache falhou
      - name: "Instalar Depend√™ncias"
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: make install-dev

      # Garantir pytest mesmo com cache sujo
      - name: "Verificar disponibilidade do pytest"
        run: .venv/bin/python -m pip install pytest pytest-xdist types-requests typer tomlkit python-frontmatter

      # Executa testes com pytest-xdist (-n auto)
      - name: "Executar Testes (Paralelo)"
        run: make test-ci

  # ====================================================================
  # JOB 3: TESTS Python 3.11 (INDEPENDENTE)
  # ====================================================================
  tests-py311:
    name: "üß™ Tests Python 3.11"
    runs-on: ubuntu-latest

    env:
      CI: true

    steps:
      - uses: actions/checkout@v6

      - name: "Configurar Python 3.11"
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      # Cache compartilhado de pip
      - name: "Cache pip downloads"
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements/dev.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      # Cache do venv Python 3.11
      - name: "Cache virtual environment"
        id: cache-venv
        uses: actions/cache@v5
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.11-${{ hashFiles('requirements/dev.txt') }}
          restore-keys: |
            venv-${{ runner.os }}-py3.11-

      # Cache do pytest (L2)
      - name: "Cache pytest"
        uses: actions/cache@v5
        with:
          path: .pytest_cache
          key: pytest-${{ runner.os }}-py3.11-${{ hashFiles('tests/**/*.py') }}
          restore-keys: |
            pytest-${{ runner.os }}-py3.11-

      # S√≥ instala se o cache falhou
      - name: "Instalar Depend√™ncias"
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: make install-dev

      # Garantir pytest mesmo com cache sujo
      - name: "Verificar disponibilidade do pytest"
        run: .venv/bin/python -m pip install pytest pytest-xdist types-requests typer tomlkit python-frontmatter

      # Executa testes com pytest-xdist (-n auto)
      - name: "Executar Testes (Paralelo)"
        run: make test-ci

  # ====================================================================
  # JOB 4: TESTS Python 3.12 (INDEPENDENTE)
  # ====================================================================
  tests-py312:
    name: "üß™ Tests Python 3.12"
    runs-on: ubuntu-latest

    env:
      CI: true

    steps:
      - uses: actions/checkout@v6

      - name: "Configurar Python 3.12"
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      # Cache compartilhado de pip
      - name: "Cache pip downloads"
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements/dev.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      # Cache do venv Python 3.12
      - name: "Cache virtual environment"
        id: cache-venv
        uses: actions/cache@v5
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.12-${{ hashFiles('requirements/dev.txt') }}
          restore-keys: |
            venv-${{ runner.os }}-py3.12-

      # Cache do pytest (L2)
      - name: "Cache pytest"
        uses: actions/cache@v5
        with:
          path: .pytest_cache
          key: pytest-${{ runner.os }}-py3.12-${{ hashFiles('tests/**/*.py') }}
          restore-keys: |
            pytest-${{ runner.os }}-py3.12-

      # S√≥ instala se o cache falhou
      - name: "Instalar Depend√™ncias"
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: make install-dev

      # Garantir pytest mesmo com cache sujo
      - name: "Verificar disponibilidade do pytest"
        run: .venv/bin/python -m pip install pytest pytest-xdist types-requests typer tomlkit python-frontmatter

      # Executa testes com pytest-xdist (-n auto)
      - name: "Executar Testes (Paralelo)"
        run: make test-ci
