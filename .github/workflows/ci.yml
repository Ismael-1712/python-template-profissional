# ======================================================================
# 噫 PISTOLﾃグ DE QUALIDADE - PYTHON (v3.0 - Makefile)
# ======================================================================
# Este workflow ﾃｩ o "Porteiro de CI" para o python-template-profissional.
#
# ARQUITETURA (Task Runner Pattern):
# Este arquivo Nﾃグ contﾃｩm lﾃｳgica de lint/teste.
# Ele delega TODAS as tarefas ao Makefile padronizado:
#
#   `make <comando>`
#
# Isso nos dﾃ｡ uma "Fonte ﾃ嗜ica da Verdade" para os comandos.
# ======================================================================

name: "噫 CI: Teste, Lint e Qualidade"

on:
  push:
    branches: [main, api, cli]
  pull_request:
    branches: [main, api, cli]
  # Permite a execuﾃｧﾃ｣o manual
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # --------------------------------------------------------------------
  # JOB 1: VERIFICAﾃﾃグ DE QUALIDADE (LINT, FORMAT, TEST)
  # --------------------------------------------------------------------
  quality-gate:
    name: "ｧｪ Teste e Qualidade"
    runs-on: ubuntu-latest

    # Estratﾃｩgia de matriz para testar em mﾃｺltiplas versﾃｵes do Python
    # (Definido no Roadmap Mestre, Prioridade 1)
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      # --- 1. CONFIGURAﾃﾃグ (Checkout e Setup) ---
      - name: "Checkout do Repositﾃｳrio"
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: "Configurar Python ${{ matrix.python-version }}"
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ matrix.python-version }}
          # Ativa o cache de dependﾃｪncias do pip
          cache: "pip"

      # --- 2. INSTALAﾃﾃグ ---
      - name: "Instalar Dependﾃｪncias"
        run: make install-dev

      # --- 3. EXECUﾃﾃグ (Delegaﾃｧﾃ｣o ao Makefile) ---
      - name: "Executar Verificaﾃｧﾃ｣o de Formataﾃｧﾃ｣o"
        run: |
          make format
          git diff --exit-code -- . ':(exclude)requirements/dev.txt'

      - name: "Executar Linting"
        run: make lint

      - name: "Executar Testes"
        run: make test
