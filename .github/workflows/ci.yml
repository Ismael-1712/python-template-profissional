# ======================================================================
# üöÄ PISTOL√ÉO DE QUALIDADE - PYTHON (v3.0 - Makefile)
# ======================================================================
# Este workflow √© o "Porteiro de CI" para o python-template-profissional.
#
# ARQUITETURA (Task Runner Pattern):
# Este arquivo N√ÉO cont√©m l√≥gica de lint/teste.
# Ele delega TODAS as tarefas ao Makefile padronizado:
#
#   `make <comando>`
#
# Isso nos d√° uma "Fonte √önica da Verdade" para os comandos.
# ======================================================================

name: "üöÄ CI: Teste, Lint e Qualidade"

on:
  push:
    branches: [main, api, cli]
  pull_request:
    branches: [main, api, cli]
  # Permite a execu√ß√£o manual
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # --------------------------------------------------------------------
  # JOB 1: VERIFICA√á√ÉO DE QUALIDADE (LINT, FORMAT, TEST)
  # --------------------------------------------------------------------
  quality-gate:
    name: "üß™ Teste e Qualidade"
    runs-on: ubuntu-latest

    # Estrat√©gia de matriz para testar em m√∫ltiplas vers√µes do Python
    # (Definido no Roadmap Mestre, Prioridade 1)
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      # --- 1. CONFIGURA√á√ÉO (Checkout e Setup) ---
      - name: "Checkout do Reposit√≥rio"
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Configurar Python ${{ matrix.python-version }}"
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ matrix.python-version }}
          # Ativa o cache de depend√™ncias do pip
          cache: "pip"

      # --- 2. INSTALA√á√ÉO ---
      - name: "Instalar Depend√™ncias"
        run: make install-dev

      # --- 2.1. AUDITORIA DE DEPEND√äNCIAS ---
      - name: "üõ°Ô∏è Audit Dependencies"
        run: .venv/bin/python scripts/audit_dependencies.py --ci

      # --- 2.2. AUDITORIA DE SEGURAN√áA EST√ÅTICA ---
      - name: "üõ°Ô∏è Security Audit (Static Analysis)"
        run: make audit

      # --- 2.3. DEBUG: VERIFICAR PACOTES INSTALADOS ---
      - name: "Debug: Listar Pacotes Instalados"
        run: |
          echo "=== Pacotes instalados (typer, fastapi, uvicorn) ==="
          .venv/bin/pip list | grep -E "(typer|fastapi|uvicorn)" || echo "‚ö†Ô∏è Depend√™ncias principais n√£o encontradas!"
          echo ""
          echo "=== Teste de import ==="
          .venv/bin/python -c "import typer; print(f'‚úÖ typer {typer.__version__} importado com sucesso!')" || echo "‚ùå Falha ao importar typer!"

      # --- 2.4. VERIFICA√á√ÉO DE SHADOW CONFIGURATION ---
      - name: "Check Undocumented Configuration"
        run: .venv/bin/python -m scripts.cli.cortex guardian check . --fail-on-error

      # --- 3. EXECU√á√ÉO (Delega√ß√£o ao Makefile) ---
      - name: "Executar Verifica√ß√£o de Formata√ß√£o"
        run: |
          make format
          git diff --exit-code -- . ':(exclude)requirements/dev.txt'

      - name: "Executar Linting"
        run: make lint

      - name: "Executar Type Checking"
        run: make type-check

      - name: "Executar Testes"
        run: make test
