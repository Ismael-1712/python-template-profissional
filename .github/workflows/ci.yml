# ======================================================================
# üöÄ PISTOL√ÉO DE QUALIDADE - PYTHON (v5.0 - Level 2 Optimization)
# ======================================================================
# Este workflow √© o "Porteiro de CI" para o python-template-profissional.
#
# ARQUITETURA H√çBRIDA (N√≠vel 1 + N√≠vel 2):
# - Cache agressivo multin√≠vel (pip, venv, mypy) por vers√£o Python
# - Setup com Matrix Strategy (Python 3.10, 3.11, 3.12)
# - Jobs paralelos otimizados:
#   * Quality (lint/security): Python 3.12 apenas
#   * Tests: Matrix completa (3.10, 3.11, 3.12)
# - Pytest-xdist para paralelismo de testes
#
# META DE PERFORMANCE: < 2 minutos (antes: 7-9min)
# ======================================================================

name: "üöÄ CI: Teste, Lint e Qualidade"

on:
  push:
    branches: [main, api, cli]
  pull_request:
    branches: [main, api, cli]
  workflow_dispatch:

permissions:
  contents: read

# Cancela workflows antigos da mesma branch para economizar tempo
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ====================================================================
  # JOB 1: SETUP ENVIRONMENT (MATRIX: Python 3.10, 3.11, 3.12)
  # ====================================================================
  # Instala depend√™ncias para cada vers√£o Python com cache inteligente.
  # Este job √© pr√©-requisito para quality e tests.
  # ====================================================================
  setup:
    name: "‚öôÔ∏è Setup Python ${{ matrix.python-version }}"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: "Checkout do Reposit√≥rio"
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Configurar Python ${{ matrix.python-version }}"
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ matrix.python-version }}

      # Cache compartilhado de pip (wheels baixados)
      - name: "Cache pip downloads"
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('requirements/dev.in') }}
          restore-keys: |
            pip-${{ runner.os }}-

      # Cache do venv espec√≠fico por vers√£o Python
      - name: "Cache virtual environment"
        id: cache-venv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('requirements/dev.in') }}
          restore-keys: |
            venv-${{ runner.os }}-py${{ matrix.python-version }}-

      # S√≥ instala se o cache falhou (primeiro run ou mudan√ßa em requirements)
      - name: "Instalar Depend√™ncias"
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: make install-dev

      # Valida√ß√£o b√°sica do ambiente instalado
      - name: "Validar Instala√ß√£o"
        run: |
          .venv/bin/python --version
          .venv/bin/pip list | head -20

  # ====================================================================
  # JOB 2: QUALITY CHECKS (Roda apenas em Python 3.12)
  # ====================================================================
  # Lint, format check, type checking e security audit.
  # Usa a vers√£o mais recente do Python para m√°xima compatibilidade.
  # ====================================================================
  quality:
    name: "üîç Quality & Security"
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Configurar Python 3.12"
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"

      # Restaura cache do venv Python 3.12
      - name: "Restaurar cache do venv"
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.12-${{ hashFiles('requirements/dev.in') }}
          fail-on-cache-miss: true

      # Cache do mypy (type checking incremental)
      - name: "Restaurar cache do mypy"
        uses: actions/cache@v4
        with:
          path: .mypy_cache
          key: mypy-${{ runner.os }}-${{ hashFiles('scripts/**/*.py', 'src/**/*.py', 'tests/**/*.py') }}
          restore-keys: |
            mypy-${{ runner.os }}-

      # Verifica√ß√£o de formata√ß√£o (ruff format --check)
      - name: "Verificar Formata√ß√£o"
        run: |
          make format
          git diff --exit-code -- . ':(exclude)requirements/dev.txt' ':(exclude)audit_metrics.json'

      # Linting (ruff check)
      - name: "Executar Linting"
        run: make lint

      # Type checking (mypy)
      - name: "Executar Type Checking"
        run: make type-check

      # Security audit (depend√™ncias + an√°lise est√°tica)
      - name: "Audit Dependencies"
        run: .venv/bin/python scripts/audit_dependencies.py --ci

      - name: "Security Audit (Static Analysis)"
        run: make audit

      # CORTEX Guardian (configura√ß√µes n√£o documentadas)
      - name: "Check Undocumented Configuration"
        run: .venv/bin/python -m scripts.cli.cortex guardian check . --fail-on-error

  # ====================================================================
  # JOB 3: TESTS (MATRIX: Python 3.10, 3.11, 3.12)
  # ====================================================================
  # Executa suite completa de testes em todas as vers√µes Python.
  # Usa pytest-xdist para paralelismo (m√∫ltiplos cores).
  # ====================================================================
  tests:
    name: "üß™ Tests Python ${{ matrix.python-version }}"
    runs-on: ubuntu-latest
    needs: setup

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: "Configurar Python ${{ matrix.python-version }}"
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ matrix.python-version }}

      # Restaura cache do venv espec√≠fico da vers√£o
      - name: "Restaurar cache do venv"
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('requirements/dev.in') }}
          fail-on-cache-miss: true

      # Executa testes com pytest-xdist (-n auto)
      - name: "Executar Testes (Paralelo)"
        run: make test
