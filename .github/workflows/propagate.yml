name: "ğŸ”„ PropagaÃ§Ã£o AutomÃ¡tica"

# ======================================================================
# AUTO-PROPAGAÃ‡ÃƒO: main â†’ api, main â†’ cli
# ======================================================================
# Este workflow implementa a propagaÃ§Ã£o automÃ¡tica de cÃ³digo da branch
# 'main' para as branches derivadas 'api' e 'cli'.
#
# ESTRATÃ‰GIA:
# - Usa Fast-Forward Only (--ff-only) para garantir linearidade
# - Falha explicitamente se houver conflitos (requer resoluÃ§Ã£o manual)
# - Executa sequencialmente para rastreabilidade clara
#
# SEGURANÃ‡A:
# - Usa GITHUB_TOKEN com escopo mÃ­nimo (contents: write)
# - Bot identificado como github-actions[bot]
# - HistÃ³rico completo preservado (fetch-depth: 0)
# ======================================================================

on:
  push:
    branches: [main]
  # Permite execuÃ§Ã£o manual para correÃ§Ãµes/testes
  workflow_dispatch:

# PermissÃ£o necessÃ¡ria para push nas branches
permissions:
  contents: write

jobs:
  # --------------------------------------------------------------------
  # JOB: PROPAGAÃ‡ÃƒO SEQUENCIAL
  # --------------------------------------------------------------------
  propagate:
    name: "ğŸ“¤ Propagar main â†’ [api, cli]"
    runs-on: ubuntu-latest

    steps:
      # --- 1. CHECKOUT COM HISTÃ“RICO COMPLETO ---
      - name: "ğŸ“¥ Checkout (HistÃ³rico Completo)"
        uses: actions/checkout@v6
        with:
          # CRÃTICO: HistÃ³rico completo necessÃ¡rio para merge
          fetch-depth: 0
          # Garante que todas as branches estÃ£o disponÃ­veis
          ref: main

      # --- 2. CONFIGURAÃ‡ÃƒO DO BOT ---
      - name: "ğŸ¤– Configurar Git Bot"
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # --- 3. VALIDAÃ‡ÃƒO PRÃ‰-PROPAGAÃ‡ÃƒO ---
      - name: "ğŸ” Validar Estado do RepositÃ³rio"
        run: |
          echo "ğŸ“Š Verificando branches remotas..."
          git fetch origin

          echo "âœ… Branch atual: $(git branch --show-current)"
          echo "âœ… Ãšltimo commit em main: $(git log -1 --oneline)"

          # Verifica se branches de destino existem
          if ! git ls-remote --heads origin api | grep -q 'refs/heads/api'; then
            echo "âŒ ERRO: Branch 'api' nÃ£o existe no remote"
            exit 1
          fi

          if ! git ls-remote --heads origin cli | grep -q 'refs/heads/cli'; then
            echo "âŒ ERRO: Branch 'cli' nÃ£o existe no remote"
            exit 1
          fi

          echo "âœ… Branches de destino validadas: api, cli"

      # --- 4. PROPAGAÃ‡ÃƒO PARA 'api' ---
      - name: "ğŸ”€ Propagar main â†’ api"
        run: |
          echo "ğŸ¯ Iniciando propagaÃ§Ã£o para branch 'api'..."

          # Checkout da branch de destino
          git checkout api
          git pull origin api

          echo "ğŸ“¦ Tentando merge fast-forward..."
          # --ff-only garante linearidade (falha se houver divergÃªncia)
          if git merge origin/main --ff-only; then
            echo "âœ… Merge fast-forward bem-sucedido"

            # Push para o remote
            git push origin api
            echo "âœ… Branch 'api' atualizada com sucesso"
            echo "ğŸ“Š Ãšltimo commit em api: $(git log -1 --oneline)"
          else
            echo "âŒ FALHA: Merge fast-forward nÃ£o Ã© possÃ­vel"
            echo "âš ï¸  A branch 'api' divergiu de 'main'"
            echo "âš ï¸  ResoluÃ§Ã£o manual necessÃ¡ria via Pull Request"
            exit 1
          fi

      # --- 5. PROPAGAÃ‡ÃƒO PARA 'cli' ---
      - name: "ğŸ”€ Propagar main â†’ cli"
        run: |
          echo "ğŸ¯ Iniciando propagaÃ§Ã£o para branch 'cli'..."

          # Checkout da branch de destino
          git checkout cli
          git pull origin cli

          echo "ğŸ“¦ Tentando merge fast-forward..."
          # --ff-only garante linearidade (falha se houver divergÃªncia)
          if git merge origin/main --ff-only; then
            echo "âœ… Merge fast-forward bem-sucedido"

            # Push para o remote
            git push origin cli
            echo "âœ… Branch 'cli' atualizada com sucesso"
            echo "ğŸ“Š Ãšltimo commit em cli: $(git log -1 --oneline)"
          else
            echo "âŒ FALHA: Merge fast-forward nÃ£o Ã© possÃ­vel"
            echo "âš ï¸  A branch 'cli' divergiu de 'main'"
            echo "âš ï¸  ResoluÃ§Ã£o manual necessÃ¡ria via Pull Request"
            exit 1
          fi

      # --- 6. RELATÃ“RIO FINAL ---
      - name: "ğŸ“‹ RelatÃ³rio de PropagaÃ§Ã£o"
        if: success()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… PROPAGAÃ‡ÃƒO CONCLUÃDA COM SUCESSO"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š RESUMO:"
          echo "  â€¢ main â†’ api: âœ… Atualizada"
          echo "  â€¢ main â†’ cli: âœ… Atualizada"
          echo ""
          echo "ğŸ” ESTADO ATUAL DAS BRANCHES:"

          # Mostra os Ãºltimos commits de cada branch
          git fetch origin
          echo ""
          echo "ğŸ“¦ main:"
          git log origin/main -1 --oneline --decorate
          echo ""
          echo "ğŸ“¦ api:"
          git log origin/api -1 --oneline --decorate
          echo ""
          echo "ğŸ“¦ cli:"
          git log origin/cli -1 --oneline --decorate
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # --- 7. NOTIFICAÃ‡ÃƒO DE FALHA ---
      - name: "âš ï¸ RelatÃ³rio de Falha"
        if: failure()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ PROPAGAÃ‡ÃƒO FALHOU"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âš ï¸  Uma ou mais branches nÃ£o puderam ser atualizadas"
          echo "âš ï¸  automaticamente devido a divergÃªncias."
          echo ""
          echo "ğŸ“‹ AÃ‡Ã•ES NECESSÃRIAS:"
          echo "  1. Revise o log acima para identificar qual branch falhou"
          echo "  2. Crie um Pull Request manual de main â†’ [branch]"
          echo "  3. Resolva os conflitos localmente"
          echo "  4. ApÃ³s merge do PR, a propagaÃ§Ã£o automÃ¡tica serÃ¡ retomada"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
