name: "ğŸ”„ PropagaÃ§Ã£o AutomÃ¡tica"

# ======================================================================
# AUTO-PROPAGAÃ‡ÃƒO: main â†’ api, main â†’ cli
# ======================================================================
# Este workflow implementa a propagaÃ§Ã£o automÃ¡tica de cÃ³digo da branch
# 'main' para as branches derivadas 'api' e 'cli'.
#
# ESTRATÃ‰GIA:
# - Usa merge recursivo para suportar branches divergentes (api/cli)
# - Permite que variaÃ§Ãµes de template mantenham diferenÃ§as especÃ­ficas
# - Executa sequencialmente para rastreabilidade clara
#
# SEGURANÃ‡A:
# - Usa GITHUB_TOKEN com escopo mÃ­nimo (contents: write)
# - Bot identificado como github-actions[bot]
# - HistÃ³rico completo preservado (fetch-depth: 0)
# ======================================================================

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  propagate:
    name: "ğŸ“¤ Propagar main â†’ [api, cli]"
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸ“¥ Checkout (HistÃ³rico Completo)"
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0
          ref: main

      - name: "ğŸ¤– Configurar Git Bot"
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: "ğŸ” Validar Estado do RepositÃ³rio"
        run: |
          echo "ğŸ“Š Verificando branches remotas..."
          git fetch origin

          if ! git ls-remote --heads origin api | grep -q 'refs/heads/api'; then
            echo "âŒ ERRO: Branch 'api' nÃ£o existe no remote"
            exit 1
          fi

          if ! git ls-remote --heads origin cli | grep -q 'refs/heads/cli'; then
            echo "âŒ ERRO: Branch 'cli' nÃ£o existe no remote"
            exit 1
          fi

      - name: "ğŸ”€ Propagar main â†’ api"
        run: |
          echo "ğŸ¯ Iniciando propagaÃ§Ã£o para branch 'api'..."
          git checkout api
          git pull origin api

          echo "ğŸ“¦ Tentando merge recursivo..."
          # Merge recursivo permite branches divergentes
          if git merge origin/main; then
            echo "âœ… Merge recursivo bem-sucedido"
            git push origin api
          else
            echo "âŒ FALHA: Merge apresentou conflitos"
            echo "âš ï¸  Conflitos na branch 'api' requerem resoluÃ§Ã£o manual"
            exit 1
          fi

      - name: "ğŸ”€ Propagar main â†’ cli"
        run: |
          echo "ğŸ¯ Iniciando propagaÃ§Ã£o para branch 'cli'..."
          git checkout cli
          git pull origin cli

          echo "ğŸ“¦ Tentando merge recursivo..."
          # Merge recursivo permite branches divergentes
          if git merge origin/main; then
            echo "âœ… Merge recursivo bem-sucedido"
            git push origin cli
          else
            echo "âŒ FALHA: Merge apresentou conflitos"
            echo "âš ï¸  Conflitos na branch 'cli' requerem resoluÃ§Ã£o manual"
            exit 1
          fi

      - name: "ğŸ“‹ RelatÃ³rio de PropagaÃ§Ã£o"
        if: success()
        run: |
          echo "âœ… PROPAGAÃ‡ÃƒO CONCLUÃDA COM SUCESSO"

      - name: "âš ï¸ RelatÃ³rio de Falha"
        if: failure()
        run: |
          echo "âŒ PROPAGAÃ‡ÃƒO FALHOU"
          echo "ğŸ“‹ AÃ‡Ã•ES NECESSÃRIAS:"
          echo "  1. Revise o log para identificar qual branch falhou"
          echo "  2. Crie um Pull Request manual de main â†’ [branch]"
